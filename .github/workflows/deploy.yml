- name: Deploy to EC2
  uses: appleboy/ssh-action@v0.1.10
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ubuntu
    key: ${{ secrets.EC2_KEY }}
    script: |
      # Set variables
      AWS_REGION=${{ env.AWS_REGION }}
      ECR_REPOSITORY=${{ env.ECR_REPOSITORY }}
      IMAGE_TAG=${{ env.IMAGE_TAG }}
      ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}

      # Install AWS CLI if not installed
      if ! command -v aws &> /dev/null
      then
          echo "Installing AWS CLI..."
          sudo apt update -y
          sudo apt install awscli -y
      fi

      # Install Docker if not installed
      if ! command -v docker &> /dev/null
      then
          echo "Installing Docker..."
          sudo apt install docker.io -y
          sudo systemctl start docker
          sudo usermod -aG docker ubuntu
      fi

      # Login to ECR
      aws ecr get-login-password --region $AWS_REGION | \
      docker login --username AWS --password-stdin \
      $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      # Stop old container
      docker stop hello-container || true
      docker rm hello-container || true

      # Pull latest image
      docker pull \
      $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG

      # Run container
      docker run -d -p 80:80 --name hello-container \
      $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG